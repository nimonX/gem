<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini AI</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="canonical" href="https://nimon.site/">

  <meta name="title" content="Gemini AI â€“ Minimal Chat Web App">
  <meta name="description" content="A clean, lightweight Gemini AI chat webapp. No logins. Runs directly from your browser.">
  <meta name="keywords" content="Gemini AI, chat app, minimal AI interface, gemini api">
  <meta name="author" content="Nimon">

  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

  <style>
    html, body { max-width:100%; overflow-x:hidden; }
    body {
      font-family: system-ui, sans-serif;
      background:#0d1117; color:#e6edf3;
      margin:0; padding:0;
      display:flex; flex-direction:column; align-items:center;
    }
    #app { max-width:800px; width:100%; padding:20px; box-sizing:border-box; }

    textarea,input,select,button,#chat { box-sizing:border-box; max-width:100%; }

    textarea {
      width:100%; background:#161b22; color:#e6edf3;
      border:1px solid #30363d; border-radius:8px;
      padding:10px; resize:vertical;
    }

    button {
      background:#238636; border:none; color:#fff;
      padding:8px 12px; border-radius:6px; cursor:pointer;
    }
    button:disabled { opacity:0.5; cursor:not-allowed; }

    #chat {
      background:#0d1117; border:1px solid #30363d;
      border-radius:8px; padding:10px;
      height:60vh; overflow-y:auto; margin-top:10px;
    }

    .user,.model {
      padding:8px 10px; border-radius:6px; margin-bottom:8px;
      max-width:90%;
    }
    .user { background:#1c2c3a; align-self:flex-end; }
    .model { background:#161b22; align-self:flex-start; }

    .meta { font-size:12px; color:#8b949e; margin-bottom:4px; }

    #historyModal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(3px);
      justify-content:center; align-items:center;
      z-index:2000;
    }
    #historyBox {
      background:#161b22; border:1px solid #30363d;
      border-radius:8px;
      width:90%; max-width:600px;
      max-height:80vh; overflow-y:auto;
      padding:20px;
    }
    .historyItem {
      padding:10px; border:1px solid #30363d;
      border-radius:6px; margin-bottom:12px;
      background:#0d1117; cursor:pointer;
    }
    .deleteEntry {
      float:right; background:#c62828; margin-left:10px;
    }

    body { padding-top:56px!important; }

    .topbar {
      position:fixed; top:0; left:0;
      width:100%; height:56px;
      background:#0d1117; border-bottom:1px solid #30363d;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 16px; z-index:1000;
    }
    .logo { display:flex; align-items:center; gap:8px; color:#e6edf3; text-decoration:none; font-weight:600; }
    .logo img { width:24px; height:24px; border-radius:4px; }
  </style>
</head>

<body>

<header class="topbar">
  <a href="index.html" class="logo">
    <img src="favicon.ico"><span>nimon.site</span>
  </a>
</header>

<div id="app">
  <h2>Gemini AI</h2>

  <div style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:8px;">
    <input id="apiKey" type="password" placeholder="Enter Gemini API key">

    <select id="modelSelect">
      <option value="gemini-2.5-pro">gemini-2.5-pro</option>
      <option value="gemini-2.5-flash">gemini-2.5-flash</option>
      <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
      <option value="gemini-2.0-flash">gemini-2.0-flash</option>
      <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
      <option value="custom">Custom</option>
    </select>

    <input id="customModel" style="display:none;" placeholder="Custom model ID">

    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="newlineToggle"> Enter = newline
    </label>
  </div>

  <button id="clearBtn">Clear Chat</button>
  <button id="historyBtn">History</button>

  <div id="chat"></div>

  <textarea id="input" rows="3" placeholder="Type your message..."></textarea>

  <div style="margin-top:10px;">
    <button id="sendBtn">Send</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>
</div>

<footer style="margin-top:30px; font-size:13px; color:#8b949e; border-top:1px solid #30363d; padding-top:15px; text-align:center;">
  <p>Runs entirely in your browser. LocalStorage only.</p>
</footer>

<!-- History Modal -->
<div id="historyModal">
  <div id="historyBox">
    <h3>Chat History</h3>
    <div id="historyContent"></div>

    <hr style="margin:15px 0; border-color:#30363d;">

    <button id="exportBtn">Export JSON</button>
    <button id="closeHistory" style="float:right;">Close</button>
  </div>
</div>

<script>
/* ============================================
   BASIC ELEMENTS
============================================ */
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const stopBtn = document.getElementById("stopBtn");
const apiKeyEl = document.getElementById("apiKey");
const modelSelectEl = document.getElementById("modelSelect");
const customModelEl = document.getElementById("customModel");
const clearBtn = document.getElementById("clearBtn");
const newlineToggle = document.getElementById("newlineToggle");

const historyBtn = document.getElementById("historyBtn");
const historyModal = document.getElementById("historyModal");
const historyContent = document.getElementById("historyContent");
const closeHistory = document.getElementById("closeHistory");
const exportBtn = document.getElementById("exportBtn");

let controller = null;
let history = [];

/* ============================================
   API KEY + OPTIONS LOAD
============================================ */
const savedKey = localStorage.getItem("gemini_api_key");
if (savedKey) apiKeyEl.value = savedKey;

apiKeyEl.addEventListener("change", () => {
  const k = apiKeyEl.value.trim();
  if (k) localStorage.setItem("gemini_api_key", k);
});

newlineToggle.checked = localStorage.getItem("enter_newline") === "true";
newlineToggle.addEventListener("change", () => {
  localStorage.setItem("enter_newline", newlineToggle.checked);
});

modelSelectEl.onchange = () => {
  customModelEl.style.display =
    modelSelectEl.value === "custom" ? "block" : "none";
};

/* ============================================
   MARKDOWN
============================================ */
const md = window.markdownit({
  breaks:true, linkify:true,
  highlight: (code, lang) => {
    if (window.hljs && lang && hljs.getLanguage(lang)) {
      try {
        return `<pre><code>${hljs.highlight(code,{language:lang}).value}</code></pre>`;
      } catch {}
    }
    return `<pre><code>${md.utils.escapeHtml(code)}</code></pre>`;
  }
});

/* ============================================
   HISTORY STORAGE
============================================ */
let savedChats = JSON.parse(localStorage.getItem("chat_history_all") || "[]");
let lastHistory = JSON.parse(localStorage.getItem("chat_last") || "[]");

if (lastHistory.length) {
  history = lastHistory;
  for (const msg of history) addMessage(msg.role, msg.parts[0].text);
}

function saveCurrentChat() {
  localStorage.setItem("chat_last", JSON.stringify(history));
}

function storeCompletedChat(chat) {
  savedChats.push({
    timestamp: new Date().toLocaleString(),
    chat: structuredClone(chat)
  });
  localStorage.setItem("chat_history_all", JSON.stringify(savedChats));
}

/* ============================================
   UI MESSAGE ADD
============================================ */
function addMessage(role,text){
  const div=document.createElement("div");
  div.className = role==="user" ? "user":"model";

  const meta=document.createElement("div");
  meta.className="meta";
  meta.textContent = role==="user" ? "You":"Gemini";

  const body=document.createElement("div");
  body.innerHTML = md.render(text);

  div.appendChild(meta);
  div.appendChild(body);

  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ============================================
   STREAMING
============================================ */
async function streamGemini(apiKey,modelId,contents,onChunk){
  const url=`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(modelId)}:streamGenerateContent?alt=sse`;

  controller=new AbortController();

  const resp=await fetch(url+`&key=${encodeURIComponent(apiKey)}`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({contents}),
    signal:controller.signal
  });

  if(!resp.ok) throw new Error(await resp.text());

  const reader=resp.body.getReader();
  const decoder=new TextDecoder();
  let buffer="";

  while(true){
    const {done,value}=await reader.read();
    if(done) break;
    buffer+=decoder.decode(value,{stream:true});
    const lines=buffer.split("\n");
    buffer=lines.pop();

    for(const line of lines){
      if(!line.startsWith("data:")) continue;
      const json=line.replace("data:","").trim();
      if(json==="[DONE]") return;

      try{
        const data=JSON.parse(json);
        const parts=data.candidates?.[0]?.content?.parts;
        if(parts) for(const p of parts) if(p.text) onChunk(p.text);
      }catch{}
    }
  }
}

/* ============================================
   SEND MESSAGE
============================================ */
async function sendMessage(){
  const apiKey=apiKeyEl.value.trim();
  if(!apiKey){ alert("Enter API key"); return; }

  localStorage.setItem("gemini_api_key",apiKey);

  let modelId=modelSelectEl.value;
  if(modelId==="custom"){
    modelId=customModelEl.value.trim();
    if(!modelId){ alert("Enter custom model"); return; }
  }

  const text=inputEl.value.trim();
  if(!text) return;

  addMessage("user",text);
  history.push({role:"user",parts:[{text}]});
  saveCurrentChat();

  inputEl.value="";

  addMessage("model","*Generating...*");
  const modelDiv = chatEl.lastChild.querySelector(".body");

  let full="";
  sendBtn.disabled=true;
  stopBtn.disabled=false;

  try{
    await streamGemini(apiKey,modelId,history,chunk=>{
      full+=chunk;
      modelDiv.textContent=full;
      chatEl.scrollTop=chatEl.scrollHeight;
    });

    modelDiv.innerHTML=md.render(full||"_No response_");

    history.push({role:"model",parts:[{text:full}]});
    saveCurrentChat();
    storeCompletedChat(history);

  }catch(err){
    modelDiv.textContent="[Error] "+err.message;
  }finally{
    sendBtn.disabled=false;
    stopBtn.disabled=true;
    controller=null;
  }
}

function stopStream(){
  if(controller) controller.abort();
  controller=null;
  stopBtn.disabled=true;
  sendBtn.disabled=false;
}

/* ============================================
   CLEAR CHAT
============================================ */
clearBtn.onclick = () => {
  history=[];
  chatEl.innerHTML="";
  localStorage.removeItem("chat_last");
};

/* ============================================
   INPUT ENTER HANDLING
============================================ */
inputEl.addEventListener("keydown",e=>{
  if(!newlineToggle.checked && e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

sendBtn.onclick = sendMessage;
stopBtn.onclick = stopStream;

/* ============================================
   HISTORY MODAL
============================================ */
historyBtn.onclick = () => {
  historyContent.innerHTML="";

  if(!savedChats.length){
    historyContent.innerHTML="<p>No saved chats.</p>";
  } else {
    savedChats.forEach((entry,i)=>{
      const preview = entry.chat
        .map(x=>`${x.role}: ${x.parts[0].text}`)
        .slice(0,3)                      // first few lines only
        .join("\n");

      const box = document.createElement("div");
      box.className="historyItem";

      box.innerHTML = `
        <strong>${entry.timestamp}</strong>
        <button class="deleteEntry" data-i="${i}">Delete</button>
        <pre style="white-space:pre-wrap;">${preview}</pre>
      `;

      // Load entire chat on click
      box.onclick = (e)=>{
        if(e.target.classList.contains("deleteEntry")) return;
        history = entry.chat;
        localStorage.setItem("chat_last", JSON.stringify(history));
        chatEl.innerHTML="";
        for(const m of history) addMessage(m.role, m.parts[0].text);
        historyModal.style.display="none";
      };

      // Delete entry
      box.querySelector(".deleteEntry").onclick = (e)=>{
        e.stopPropagation();
        savedChats.splice(i,1);
        localStorage.setItem("chat_history_all", JSON.stringify(savedChats));
        historyBtn.onclick(); // refresh
      };

      historyContent.appendChild(box);
    });
  }

  historyModal.style.display="flex";
};

closeHistory.onclick = () => {
  historyModal.style.display="none";
};

/* Export */
exportBtn.onclick = () => {
  const blob = new Blob(
    [JSON.stringify(savedChats,null,2)],
    {type:"application/json"}
  );
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="chat_history.json"; a.click();
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
