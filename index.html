<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gemini AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Markdown & Syntax Highlighting -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

<style>
body {
  font-family: system-ui, sans-serif;
  background:#0d1117; color:#e6edf3; margin:0; padding:0;
  display:flex; flex-direction:column; align-items:center;
}
#app { max-width:800px; width:100%; padding:20px; }
textarea { width:100%; background:#161b22; color:#e6edf3;
  border:1px solid #30363d; border-radius:8px; padding:10px; resize:vertical; }
button { background:#238636; border:none; color:#fff; padding:8px 12px;
  border-radius:6px; cursor:pointer; }
button:disabled{opacity:0.5;cursor:not-allowed}
#chat { background:#0d1117; border:1px solid #30363d; border-radius:8px;
  padding:10px; height:60vh; overflow-y:auto; margin-top:10px; }
.user,.model { padding:8px 10px; border-radius:6px; margin-bottom:8px; max-width:90%; }
.user { background:#1c2c3a; align-self:flex-end; }
.model { background:#161b22; align-self:flex-start; }
.meta { font-size:12px; color:#8b949e; margin-bottom:4px; }
#apiKey, #modelSelect, #customModel { width:300px; margin-right:8px; }
#customModel { display:none; margin-top:8px; }
pre { background:#0d1117; border-radius:6px; padding:8px; overflow-x:auto; }
table { border-collapse: collapse; margin-top:6px; margin-bottom:6px; }
table, th, td { border:1px solid #30363d; }
th, td { padding:6px 10px; }
th { background:#161b22; }

/* Toggle switch */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 22px;
  margin-left: 10px;
}
.switch input { display:none; }
.slider {
  position:absolute;
  cursor:pointer;
  top:0; left:0; right:0; bottom:0;
  background-color:#555;
  transition:.3s;
  border-radius:22px;
}
.slider:before {
  position:absolute;
  content:"";
  height:16px; width:16px;
  left:3px; bottom:3px;
  background-color:white;
  transition:.3s;
  border-radius:50%;
}
input:checked + .slider {
  background-color:#238636;
}
input:checked + .slider:before {
  transform:translateX(22px);
}
label.toggleLabel { font-size:14px; margin-left:6px; vertical-align:middle; }
</style>
</head>

<body>
<div id="app">
  <h2>Gemini AI</h2>
  <h3>Get your API key from: <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com/app/apikey</a></h3>

  <div style="margin-bottom:10px; display:flex; align-items:center; flex-wrap:wrap; gap:8px;">
    <input id="apiKey" type="password" placeholder="Enter Gemini API key">
    <select id="modelSelect">
      <option value="gemini-2.5-pro" selected>gemini-2.5-pro</option>
      <option value="gemini-2.5-flash">gemini-2.5-flash</option>
      <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
      <option value="gemini-2.0-flash">gemini-2.0-flash</option>
      <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite</option>
      <option value="custom">Custom model ID...</option>
    </select>
    <button id="clearBtn">Clear Chat</button>
    <div>
      <label class="switch">
        <input type="checkbox" id="newlineToggle">
        <span class="slider"></span>
      </label>
      <label for="newlineToggle" class="toggleLabel">Enter = Newline</label>
    </div>
  </div>

  <input id="customModel" type="text" placeholder="Enter custom model ID (e.g. gemini-3.0-preview)">

  <div id="chat"></div>

  <textarea id="input" rows="3" placeholder="Type your message..."></textarea>
  <div style="margin-top:10px">
    <button id="sendBtn">Send</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>
</div>

<footer style="margin-top:30px; font-size:13px; color:#8b949e; text-align:center; border-top:1px solid #30363d; padding-top:15px; margin-top:40px;">
  <p>
    <strong>Privacy:</strong> This web app runs entirely in your browser. 
    Your API key and chat history are stored locally using <code>localStorage</code> 
    and are never sent anywhere except directly to Google's Gemini API.
  </p>
  <p>
    <a href="https://github.com/nimonX/gem" target="_blank" style="color:#58a6ff;">
      GitHub: @nimonX/gem
    </a>
    &nbsp;â€¢&nbsp; 2025
  </p>
</footer>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const stopBtn = document.getElementById('stopBtn');
const apiKeyEl = document.getElementById('apiKey');
const modelSelectEl = document.getElementById('modelSelect');
const customModelEl = document.getElementById('customModel');
const clearBtn = document.getElementById('clearBtn');
const newlineToggle = document.getElementById('newlineToggle');

let controller = null;
let history = [];

// --- Load saved API key ---
const savedKey = localStorage.getItem('gemini_api_key');
if (savedKey) apiKeyEl.value = savedKey;

// Save API key when changed
apiKeyEl.addEventListener('change', () => {
  const key = apiKeyEl.value.trim();
  if (key) localStorage.setItem('gemini_api_key', key);
});

// --- Load saved newline mode ---
const savedNewline = localStorage.getItem('enter_newline') === 'true';
newlineToggle.checked = savedNewline;

// Save newline mode when toggled
newlineToggle.addEventListener('change', () => {
  localStorage.setItem('enter_newline', newlineToggle.checked);
});

// Markdown renderer
const md = window.markdownit({
  html: false,
  linkify: true,
  breaks: true,
  highlight: (code, lang) => {
    if (typeof window.hljs !== "undefined" && lang && hljs.getLanguage(lang)) {
      try {
        const highlighted = hljs.highlight(code, { language: lang, ignoreIllegals: true }).value;
        return `<pre class="hljs"><code>${highlighted}</code></pre>`;
      } catch (_) {}
    }
    return `<pre class="hljs"><code>${md.utils.escapeHtml(code)}</code></pre>`;
  }
});

// Show/hide custom model
modelSelectEl.addEventListener('change', () => {
  customModelEl.style.display = modelSelectEl.value === 'custom' ? 'block' : 'none';
});

function addMessage(role, text) {
  const div = document.createElement('div');
  div.className = role === 'user' ? 'user' : 'model';
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = role === 'user' ? 'You' : 'Gemini';
  div.appendChild(meta);
  const body = document.createElement('div');
  body.className = 'body';
  body.innerHTML = md.render(text || '');
  div.appendChild(body);
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return body;
}

async function streamGemini(apiKey, modelId, contents, onChunk) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(modelId)}:streamGenerateContent?alt=sse`;
  controller = new AbortController();
  const resp = await fetch(url + `&key=${encodeURIComponent(apiKey)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ contents }),
    signal: controller.signal
  });
  if (!resp.ok) throw new Error(await resp.text());

  const reader = resp.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buffer = "";
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.trim().startsWith("data:")) continue;
      const json = line.replace(/^data:\s*/, "");
      if (json === "[DONE]") return;
      try {
        const data = JSON.parse(json);
        const parts = data.candidates?.[0]?.content?.parts;
        if (parts) for (const p of parts) if (p.text) onChunk(p.text);
      } catch {}
    }
  }
}

async function sendMessage() {
  const apiKey = apiKeyEl.value.trim();
  if (!apiKey) { alert("Enter your Gemini API key"); return; }
  localStorage.setItem('gemini_api_key', apiKey);

  let modelId = modelSelectEl.value;
  if (modelId === 'custom') {
    modelId = customModelEl.value.trim();
    if (!modelId) { alert("Enter custom model ID"); return; }
  }

  const text = inputEl.value.trim();
  if (!text) return;

  addMessage("user", text);
  history.push({ role: "user", parts: [{ text }] });
  inputEl.value = "";

  const modelBody = addMessage("model", "");
  let full = "";
  sendBtn.disabled = true;
  stopBtn.disabled = false;

  try {
    await streamGemini(apiKey, modelId, history, chunk => {
      full += chunk;
      modelBody.textContent = full;
      chatEl.scrollTop = chatEl.scrollHeight;
    });
    modelBody.innerHTML = md.render(full);
    history.push({ role: "model", parts: [{ text: full }] });
  } catch (err) {
    modelBody.textContent = "[Error] " + err.message;
  } finally {
    sendBtn.disabled = false;
    stopBtn.disabled = true;
    controller = null;
  }
}

function stopStream() {
  if (controller) controller.abort();
  controller = null;
  stopBtn.disabled = true;
  sendBtn.disabled = false;
}

sendBtn.onclick = sendMessage;
stopBtn.onclick = stopStream;
clearBtn.onclick = () => { history = []; chatEl.innerHTML = ""; };

// Enter key behavior depends on toggle
inputEl.addEventListener("keydown", e => {
  if (!newlineToggle.checked && e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>
